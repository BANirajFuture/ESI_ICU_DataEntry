// This is conceptual server-side code, not part of the HTML file
const express = require('express');
const bodyParser = require('body-parser');
const { Pool } = require('pg'); // PostgreSQL client
const bcrypt = require('bcrypt'); // For password hashing

const app = express();
const port = 3000;

// Database connection pool (replace with your actual credentials)
const pool = new Pool({
    user: 'your_db_user',
    host: 'localhost',
    database: 'your_db_name',
    password: 'your_db_password',
    port: 5432,
});

app.use(bodyParser.json());
app.use(express.static('public')); // Serve your index.html from a 'public' folder

// Simple hardcoded user for demonstration (still bad practice for real apps)
const users = {
    "user123": "$2b$10$abcdefghijklmnopqrstuvwxyza.hash" // Hashed password for "password123"
};

// Middleware for authentication (simplified)
function authenticateUser(req, res, next) {
    const { username, password } = req.body; // Assuming login data in body for simplicity
    if (users[username] && bcrypt.compareSync(password, users[username])) {
        next(); // User authenticated
    } else {
        res.status(401).send('Unauthorized');
    }
}

// Endpoint to handle data submission
app.post('/api/icu-data', authenticateUser, async (req, res) => {
    const { bedNumber, patientName, admissionDate, status, lifeSupport, comments, age, gender } = req.body;

    // Server-side validation (more robust than client-side)
    if (!bedNumber || !patientName || !admissionDate || !status || !lifeSupport || !age || !gender) {
        return res.status(400).send('All required fields must be provided.');
    }

    try {
        const lastUpdate = new Date().toISOString().slice(0, 19).replace('T', ' '); // YYYY-MM-DD HH:MM:SS
        const admission = new Date(admissionDate);
        const today = new Date();
        admission.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        const icuDuration = Math.ceil(Math.abs(today - admission) / (1000 * 60 * 60 * 24)) + 1;

        const query = `
            INSERT INTO "ESI_ICU_Data" (
                "बेड संख्या", नाम, "प्रवेश तिथि", स्थिति, "जीवन सहायक", टिप्पणी, आयु, जेंडर, "अंतिम अपडेट", "आईसीयू में भर्ती अवधि"
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
            RETURNING *;
        `;
        const values = [
            bedNumber, patientName, admissionDate, status, lifeSupport, comments, age, gender,
            lastUpdate, icuDuration
        ];

        const result = await pool.query(query, values);
        res.status(201).json(result.rows[0]); // Send back the inserted row
    } catch (error) {
        console.error('Error inserting data:', error);
        res.status(500).send('Error saving data to database.');
    }
});

// Create the table if it doesn't exist (run once or use migrations)
async function createTable() {
    try {
        await pool.query(`
            CREATE TABLE IF NOT EXISTS "ESI_ICU_Data" (
                id SERIAL PRIMARY KEY,
                "बेड संख्या" VARCHAR(50) NOT NULL,
                नाम VARCHAR(255) NOT NULL,
                "प्रवेश तिथि" DATE NOT NULL,
                स्थिति VARCHAR(50) NOT NULL,
                "जीवन सहायक" VARCHAR(10) NOT NULL,
                टिप्पणी TEXT,
                आयु INTEGER NOT NULL,
                जेंडर VARCHAR(50) NOT NULL,
                "अंतिम अपडेट" TIMESTAMP NOT NULL,
                "आईसीयू में भर्ती अवधि" INTEGER NOT NULL
            );
        `);
        console.log('Table "ESI_ICU_Data" ensured.');
    } catch (err) {
        console.error('Error creating table:', err);
    }
}

app.listen(port, () => {
    console.log(`Server listening at http://localhost:${port}`);
    createTable(); // Ensure table exists on server start
});
